#!/bin/bash

#
# Project:        vfio-script
# Filename:       select_device_src
# Description:    User interaction logic.
# Author(s):      Alex Portell <github.com/portellam>
# Maintainer(s):  Alex Portell <github.com/portellam>
# Version:        0.0.1
#

#region Sources

SOURCE_PATH="${1}"
shift
COLUMN_SIZE="$( tput cols )"

source \
  "${SOURCE_PATH}print_src" \
  "${SOURCE_PATH}" \
  "${COLUMN_SIZE}"

#endregion

#region Parameters

DELIMITER=","

HARDWARE_ID_REGEX='^[a-zA-Z0-9]{4}:[a-zA-Z0-9]{4}$'
HARDWARE_ID_DELIM_REGEX='^(\s*,\s*|\s*([A-Za-z0-9]{4}:\s*[A-Za-z0-9]{4})\s*,\s*)*$'
IOMMU_GROUP_REGEX="^[0-9]+$"
IOMMU_GROUP_DELIM_REGEX="^([0-9]+)(,[0-9]+)*$"
WORD_REGEX="^[a-zA-Z]+$"
WORD_DELIM_REGEX="^[a-zA-Z]+(,[a-zA-Z]+)*$"

#endregion

#region Logic

  #region Drivers

  #
  # $1 : the comma delimited list of whitelisted devices' drivers as a reference.
  # $2 : the comma delimited list of blacklisted devices' drivers.
  #
  function selection_src_get_vfio_drivers
  {
    if is_string "${2}" \
      && ! [[ "${2}" =~ "${HARDWARE_ID_REGEX}" ]] \
      && ! [[ "${2}" =~ "${HARDWARE_ID_DELIM_REGEX}" ]]; then
      print_error_to_log "Invalid blacklisted devices' drivers."
      return 2
    fi

    if [[ "${2}" == *"vfio-pci"* ]] \
      || [[ "${2}" == *"pci-stub"* ]]; then
      print_error_to_log "Blacklisted devices' contain VFIO placeholder drivers."
      return 2
    fi

    if ! remove_range \
        "${DELIMITER}" \
        "${1}" \
        "${2}"; then
      return 1
    fi

    return 0
  }

  #
  # $1 : true/false enable verbosity.
  # $2 : true/false skip prompt.
  # $3 : the comma delimited list of blacklisted devices' drivers as a reference.
  #
  function selection_src_select_blacklisted_drivers
  {
    if ! is_boolean "${1}" \
      || ! is_boolean "${2}" \
      || ! is_reference "${3}"; then
      return 2
    fi

    local do_enable_verbosity="${1}"
    local do_skip_prompt="${2}"
    local -n blacklisted_drivers_delim_ref="${3}"

    local error="Invalid blacklisted devices' drivers."
    local verbose_error="Please enter a comma-delimited list of devices' drivers."

    if is_string "${blacklisted_drivers_delim_ref}" \
      && ! [[ "${blacklisted_drivers_delim_ref}" =~ "${WORD_REGEX}" ]] \
      && ! [[ "${blacklisted_drivers_delim_ref}" =~ "${WORD_DELIM_REGEX}" ]]; then
      print_error_to_log "${error}"

      if "${do_enable_verbosity}"; then
        print_error_to_log "${verbose_error}"
      fi

      return 2
    fi

    for index in $( seq 0 2 ); do
      if "${do_enable_verbosity}"; then
        echo \
          -en \
          "Enter a comma-delimited list of devices' drivers to blacklist" \
          " from the Host machine (leave blank to skip): "

      else
        echo \
          -en \
          "Enter a comma-delimited list of blacklisted devices' drivers: "
      fi

      read blacklisted_drivers_delim_ref

      if ! is_string "${blacklisted_drivers_delim_ref}"; then
        do_skip_prompt=true
      fi

      if "${do_skip_prompt}"; then
        if "${do_enable_verbosity}"; then
          print_output_to_log "Skipped."
        fi

        return 0
      fi

      if [[ "${blacklisted_drivers_delim_ref}" =~ "${WORD_REGEX}" ]] \
        || [[ "${blacklisted_drivers_delim_ref}" =~ "${WORD_DELIM_REGEX}" ]]; then
        print_output_to_log "Validated blacklisted devices' drivers."
        return 0
      fi
    done

    print_error_to_log "${error}"

    if "${do_enable_verbosity}"; then
      print_error_to_log "${verbose_error}"
    fi

    return 1
  }

  #
  # $1 : true/false enable verbosity.
  # $2 : true/false skip prompt.
  # $3 : the comma delimited list of whitelisted devices' drivers as a reference.
  #
  function selection_src_select_whitelisted_drivers
  {
    if ! is_boolean "${1}" \
      || ! is_boolean "${2}" \
      || ! is_reference "${3}"; then
      return 2
    fi

    local do_enable_verbosity="${1}"
    local do_skip_prompt="${2}"
    local -n whitelisted_drivers_delim_ref="${3}"

    local error="Invalid whitelisted devices' drivers."
    local verbose_error="Please enter a comma-delimited list of devices' drivers."

    if is_string "${whitelisted_drivers_delim_ref}" \
      && ! [[ "${whitelisted_drivers_delim_ref}" =~ "${WORD_REGEX}" ]] \
      && ! [[ "${whitelisted_drivers_delim_ref}" =~ "${WORD_DELIM_REGEX}" ]]; then
      print_error_to_log "${error}"

      if "${do_enable_verbosity}"; then
        print_error_to_log "${verbose_error}"
      fi

      return 2
    fi

    for index in $( seq 0 2 ); do
      if "${do_enable_verbosity}"; then
        echo \
          -en \
          "Enter a comma-delimited list of devices' drivers to reserve for the" \
          " Host machine (leave blank to skip): "

      else
        echo \
          -en \
          "Enter a comma-delimited list of whitelisted devices' drivers: "
      fi

      read whitelisted_drivers_delim_ref

      if ! is_string "${whitelisted_drivers_delim_ref}"; then
        do_skip_prompt=true
      fi

      if "${do_skip_prompt}"; then
        if "${do_enable_verbosity}"; then
          print_output_to_log "Skipped."
        fi

        return 0
      fi

      if [[ "${whitelisted_drivers_delim_ref}" =~ "${WORD_REGEX}" ]] \
        || [[ "${whitelisted_drivers_delim_ref}" =~ "${WORD_DELIM_REGEX}" ]]; then
        print_output_to_log "Validated whitelisted devices' drivers."
        return 0
      fi
    done

    print_error_to_log "${error}"

    if "${do_enable_verbosity}"; then
      print_error_to_log "${verbose_error}"
    fi

    return 1
  }

  #endregion

  #region IOMMU

  #
  # $1 : the comma delimited list of whitelisted IOMMU groups as a reference.
  # $2 : the comma delimited list of blacklisted IOMMU groups.
  #
  function selection_src_get_vfio_iommu_groups
  {
    if is_string "${2}" \
      && ! [[ "${2}" =~ "${IOMMU_GROUP_REGEX}" ]] \
      && ! [[ "${2}" =~ "${IOMMU_GROUP_DELIM_REGEX}" ]]; then
      print_error_to_log "Invalid blacklisted IOMMU groups."
      return 2
    fi

    if ! remove_range \
        "${DELIMITER}" \
        "${1}" \
        "${2}"; then
      return 1
    fi

    return 0
  }

  #
  # $1 : true/false enable verbosity.
  # $2 : true/false skip prompt.
  # $3 : the comma delimited list of blacklisted IOMMU groups as a reference.
  #
  function selection_src_select_blacklisted_iommu_groups
  {
    if ! is_boolean "${1}" \
      || ! is_boolean "${2}" \
      || ! is_reference "${3}"; then
      return 2
    fi

    local do_enable_verbosity="${1}"
    local do_skip_prompt="${2}"
    local -n blacklisted_iommu_groups_delim_ref="${3}"

    local error="Invalid blacklisted IOMMU groups."
    local verbose_error="Please enter a comma-delimited list of positive integers."

    if is_string "${blacklisted_iommu_groups_delim_ref}" \
      && ! [[ "${blacklisted_iommu_groups_delim_ref}" =~ "${IOMMU_GROUP_REGEX}" ]] \
      && ! [[ "${blacklisted_iommu_groups_delim_ref}" =~ "${IOMMU_GROUP_DELIM_REGEX}" ]]; then
      print_error_to_log "${error}"

      if "${do_enable_verbosity}"; then
        print_error_to_log "${verbose_error}"
      fi

      return 2
    fi

    for index in $( seq 0 2 ); do
      if "${do_enable_verbosity}"; then
        echo \
          -en \
          "Enter a comma-delimited list of IOMMU groups (positive integers) to" \
          " reserve for any Guest machine (to exclude from the Host machine)" \
          " (leave blank to skip): "

      else
        echo \
          -en \
          "Enter a comma-delimited list of blacklisted IOMMU groups: "
      fi

      read blacklisted_iommu_groups_delim_ref

      if ! is_string "${blacklisted_iommu_groups_delim_ref}"; then
        do_skip_prompt=true
      fi

      if "${do_skip_prompt}"; then
        if "${do_enable_verbosity}"; then
          print_output_to_log "Skipped."
        fi

        return 0
      fi

      if [[ "${blacklisted_iommu_groups_delim_ref}" =~ "${IOMMU_GROUP_REGEX}" ]] \
        || [[ "${blacklisted_iommu_groups_delim_ref}" =~ "${IOMMU_GROUP_DELIM_REGEX}" ]]; then
        print_output_to_log "Validated blacklisted IOMMU groups."
        return 0
      fi
    done

    print_error_to_log "${error}"

    if "${do_enable_verbosity}"; then
      print_error_to_log "${verbose_error}"
    fi

    return 1
  }

  #
  # $1 : true/false enable verbosity.
  # $2 : true/false skip prompt.
  # $3 : the comma delimited list of whitelisted IOMMU groups as a reference.
  #
  function selection_src_select_whitelisted_iommu_groups
  {
    if ! is_boolean "${1}" \
      || ! is_boolean "${2}" \
      || ! is_reference "${3}"; then
      return 2
    fi

    local do_enable_verbosity="${1}"
    local do_skip_prompt="${2}"
    local -n whitelisted_iommu_groups_delim_ref="${3}"

    local error="Invalid whitelisted IOMMU groups."
    local verbose_error="Please enter a comma-delimited list of positive integers."

    if is_string "${whitelisted_iommu_groups_delim_ref}" \
      && ! [[ "${whitelisted_iommu_groups_delim_ref}" =~ "${IOMMU_GROUP_REGEX}" ]] \
      && ! [[ "${whitelisted_iommu_groups_delim_ref}" =~ "${IOMMU_GROUP_DELIM_REGEX}" ]]; then
      print_error_to_log "${error}"

      if "${do_enable_verbosity}"; then
        print_error_to_log "${verbose_error}"
      fi

      return 2
    fi

    for index in $( seq 0 2 ); do
      if "${do_enable_verbosity}"; then
        echo \
          -en \
          "Enter a comma-delimited list of IOMMU groups (positive integers) to" \
          " reserve for the Host machine (to exclude from any Guest machines)" \
          " (leave blank to skip): "

      else
        echo \
          -en \
          "Enter a comma-delimited list of whitelisted IOMMU groups: "
      fi

      read whitelisted_iommu_groups_delim_ref

      if ! is_string "${whitelisted_iommu_groups_delim_ref}"; then
        do_skip_prompt=true
      fi

      if "${do_skip_prompt}"; then
        if "${do_enable_verbosity}"; then
          print_output_to_log "Skipped."
        fi

        return 0
      fi

      if [[ "${whitelisted_iommu_groups_delim_ref}" =~ "${IOMMU_GROUP_REGEX}" ]] \
        || [[ "${whitelisted_iommu_groups_delim_ref}" =~ "${IOMMU_GROUP_DELIM_REGEX}" ]]; then
        print_output_to_log "Validated whitelisted IOMMU groups."
        return 0
      fi
    done

    print_error_to_log "${error}"

    if "${do_enable_verbosity}"; then
      print_error_to_log "${verbose_error}"
    fi

    return 1
  }

  #endregion

  #region Hardware IDs

  #
  # $1 : the comma delimited list of whitelisted devices' IDs as a reference.
  # $2 : the comma delimited list of blacklisted devices' IDs.
  #
  function selection_src_get_vfio_hardware_ids
  {
    if is_string "${2}" \
      && ! [[ "${2}" =~ "${HARDWARE_ID_REGEX}" ]] \
      && ! [[ "${2}" =~ "${HARDWARE_ID_DELIM_REGEX}" ]]; then
      print_error_to_log "Invalid blacklisted devices' IDs."
      return 2
    fi

    if ! remove_range \
        "${DELIMITER}" \
        "${1}" \
        "${2}"; then
      return 1
    fi

    return 0
  }

  #
  # $1 : true/false enable verbosity.
  # $2 : true/false skip prompt.
  # $3 : true/false use driver "vfio-pci" or "pci-stub".
  # $4 : the comma delimited list of blacklisted devices' IDs as a reference.
  #
  function selection_src_select_blacklisted_hardware_ids
  {
    if ! is_boolean "${1}" \
      || ! is_boolean "${2}" \
      || ! is_boolean "${3}" \
      || ! is_reference "${4}"; then
      return 2
    fi

    local do_enable_verbosity="${1}"
    local do_skip_prompt="${2}"
    local do_use_vfio_pci="${3}"
    local -n blacklisted_hardware_ids_delim_ref="${4}"

    local placeholder_driver="vfio-pci"

    if ! "${do_use_vfio_pci}"; then
      placeholder_driver="pci-stub"
    fi

    local error="Invalid blacklisted devices' IDs"
    error+=" (using driver \"${placeholder_driver}\")."
    local verbose_error="Please enter a comma-delimited list of colon-delimited"
    verbose_error+="strings of two, with alphanumeric text."

    if is_string "${blacklisted_hardware_ids_delim_ref}" \
      && ! [[ "${blacklisted_hardware_ids_delim_ref}" =~ "${HARDWARE_ID_REGEX}" ]] \
      && ! [[ "${blacklisted_hardware_ids_delim_ref}" =~ "${HARDWARE_ID_DELIM_REGEX}" ]]; then
      print_error_to_log "${error}"

      if "${do_enable_verbosity}"; then
        print_error_to_log "${verbose_error}"
      fi

      return 2
    fi

    for index in $( seq 0 2 ); do
      if "${do_enable_verbosity}"; then
        echo \
          -en \
          "Enter a comma-delimited list of devices' IDs"\
          " (colon-delimited strings of two, with alphanumeric text) to" \
          " blacklist from the Host machine and use the driver" \
          "\"${placeholder_driver}\" (leave blank to skip): "

      else
        echo \
          -en \
          "Enter a comma-delimited list of blacklisted devices' IDs: "
      fi

      read blacklisted_hardware_ids_delim_ref

      if ! is_string "${blacklisted_hardware_ids_delim_ref}"; then
        do_skip_prompt=true
      fi

      if "${do_skip_prompt}"; then
        if "${do_enable_verbosity}"; then
          print_output_to_log "Skipped."
        fi

        return 0
      fi

      if [[ "${blacklisted_hardware_ids_delim_ref}" =~ "${HARDWARE_ID_REGEX}" ]] \
        || [[ "${blacklisted_hardware_ids_delim_ref}" =~ "${HARDWARE_ID_DELIM_REGEX}" ]]; then
        print_output_to_log "Validated blacklisted devices' IDs."
        return 0
      fi
    done

    print_error_to_log "${error}"

    if "${do_enable_verbosity}"; then
      print_error_to_log "${verbose_error}"
    fi

    return 1
  }

  #
  # $1 : true/false enable verbosity.
  # $2 : true/false skip prompt.
  # $4 : the comma delimited list of whitelisted devices' IDs as a reference.
  #
  function selection_src_select_whitelisted_hardware_ids
  {
    if ! is_boolean "${1}" \
      || ! is_boolean "${2}" \
      || ! is_reference "${3}"; then
      return 2
    fi

    local do_enable_verbosity="${1}"
    local do_skip_prompt="${2}"
    local -n whitelisted_hardware_ids_delim_ref="${3}"

    local error="Invalid whitelisted devices' IDs."
    local verbose_error="Please enter a comma-delimited list of colon-delimited"
    verbose_error+="strings of two, with alphanumeric text."

    if is_string "${whitelisted_hardware_ids_delim_ref}" \
      && ! [[ "${whitelisted_hardware_ids_delim_ref}" =~ "${HARDWARE_ID_REGEX}" ]] \
      && ! [[ "${whitelisted_hardware_ids_delim_ref}" =~ "${HARDWARE_ID_DELIM_REGEX}" ]]; then
      print_error_to_log "${error}"

      if "${do_enable_verbosity}"; then
        print_error_to_log "${verbose_error}"
      fi

      return 2
    fi

    for index in $( seq 0 2 ); do
      if "${do_enable_verbosity}"; then
        echo \
          -en \
          "Enter a comma-delimited list of devices' IDs"\
          " (colon-delimited strings of two, with alphanumeric text) to" \
          " reserve for the Host machine (leave blank to skip): "

      else
        echo \
          -en \
          "Enter a comma-delimited list of whitelisted devices' IDs: "
      fi

      read whitelisted_hardware_ids_delim_ref

      if ! is_string "${whitelisted_hardware_ids_delim_ref}"; then
        do_skip_prompt=true
      fi

      if "${do_skip_prompt}"; then
        if "${do_enable_verbosity}"; then
          print_output_to_log "Skipped."
        fi

        return 0
      fi

      if [[ "${whitelisted_hardware_ids_delim_ref}" =~ "${HARDWARE_ID_REGEX}" ]] \
        || [[ "${whitelisted_hardware_ids_delim_ref}" =~ "${HARDWARE_ID_DELIM_REGEX}" ]]; then
        print_output_to_log "Validated whitelisted devices' IDs."
        return 0
      fi
    done

    print_error_to_log "${error}"

    if "${do_enable_verbosity}"; then
      print_error_to_log "${verbose_error}"
    fi

    return 1
  }

  #endregion

#endregion